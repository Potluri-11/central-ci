#       - name:  Gradle
#         uses:  gradle/gradle-build-action@v2


#       - name: SBOM
#         uses: aquasecurity/trivy-action@master
#         with:
#           scan-type: fs
#           scan-ref: .
#           format: spdx-json
#           output: sbom.json
#       - name: Trivy
#         uses: aquasecurity/trivy-action@master
#         with:
#           scan-type: fs
#           scan-ref: .
#           severity: CRITICAL,HIGH
#           exit-code: 1 
# # DOCKER BUILD 
#       - name: Login to container registry
#         uses: docker/login-action@v3
#         with:
#           registry: ghcr.io
#           username: ${{ github.actor }}
#           password: ${{ secrets.GITHUB_TOKEN }}
#       - name: Build and push 
#         uses: docker/build-push-action@v5
#         with:
#           context: .
#           push: true
#           tags: ${{ inputs.image-ref }}
# # COSIGN
#       - name: Install Cosign
#         uses: sigstore/cosign-installer@v3 
#       - name: Sign container image
#         run: cosign sign ${{ inputs.image-ref }}
#         env:
#           COSIGN_EXPERIMENTAL: "true" 
#           COSIGN_YES: "true"
#       # - name: Verify container image signature
#       #   run: |
#       #     cosign verify \
#       #     --certificate-identity-regexp "https://github.com/Potluri-11/.*" \
#       #     --certificate-oidc-issuer https://token.actions.githubusercontent.com \
#       #     ${{ inputs.image-ref }}

# # #  KYVERNO
# #       - name: Install Kyverno CLI
# #         run: |
# #           curl -LO https://github.com/kyverno/kyverno/releases/latest/download/kyverno-cli_linux_x86_64
# #           chmod +x kyverno-cli_linux_x86_64
# #           sudo mv kyverno-cli_linux_x86_64 /usr/local/bin/kyverno
# #       -  name:
# #          run: |
# #            kyverno apply policies/ manifests/ --cluster
#       - name: Install Kyverno CLI
#         run: |
#           curl -LO https://github.com/kyverno/kyverno/releases/latest/download/kyverno-cli_linux_x86_64
#           chmod +x kyverno-cli_linux_x86_64
#           sudo mv kyverno-cli_linux_x86_64 /usr/local/bin/kyverno
#           kyverno version
#       -  name:
#         run: |
#           kyverno apply policies/ manifests/ --cluster

name: Reusable CI â€“ Quality, Security & Signing

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
      unit-test:
        required: true
        type: string
      integration-test:
        required: true
        type: string
      code-coverage:
        required: true
        type: string
      image-ref:
        required: true
        type: string

permissions:
  contents: write    
  packages: write   
  id-token: write   

jobs:
  #pipeline:
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Unit test
        run: ${{ inputs.unit-test }}
      - name: Integration tests
        run: ${{ inputs.integration-test }}
      - name: coverage report
        run: ${{ inputs.code-coverage }}
      - name: Test report
        uses:  actions/upload-artifact@v4
        with:
          name:  Reports
          path:  build/reports/jacoco/test
      - name: Pages
        run: |
          mkdir -p public
          cp -r build/reports/jacoco/test/html/* public/
      - name: Deploying reports to Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public

      - name: SBOM
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: spdx-json
          output: sbom.json
      - name: Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH
          exit-code: 1 
# DOCKER BUILD 
      - name: Login to container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push 
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ inputs.image-ref }}
# COSIGN
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3 
      - name: Sign container image
        run: cosign sign ${{ inputs.image-ref }}
        env:
          COSIGN_EXPERIMENTAL: "true" 
          COSIGN_YES: "true"
#  KYVERNO
      - name: Install Kyverno CLI
        run: |
          curl -L https://github.com/kyverno/kyverno/releases/download/v1.12.4/kyverno-cli_v1.12.4_linux_x86_64.tar.gz -o kyverno.tar.gz
          tar -xzf kyverno.tar.gz
          sudo mv kyverno /usr/local/bin/kyverno
          kyverno version
      - name: Verifying signed image
        run: |
          kyverno apply policies/ --resource manifests/signed-image.yaml

